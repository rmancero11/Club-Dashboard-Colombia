// ================== Generators/Datasource ==================
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ================== Enums ==================
enum Role {
  USER
  ADMIN
  SELLER
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum ReservationStatus {
  LEAD
  QUOTED
  HOLD
  CONFIRMED
  TRAVELING
  COMPLETED
  CANCELED
  EXPIRED
}

enum DocumentType {
  PURCHASE_ORDER
  FLIGHT_TICKETS
  SERVICE_VOUCHER
  MEDICAL_ASSISTANCE_CARD
  TRAVEL_TIPS
}

enum TaskStatus {
  OPEN
  IN_PROGRESS
  BLOCKED
  DONE
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

enum ActivityAction {
  LOGIN
  LOGOUT
  CREATE_CLIENT
  UPDATE_CLIENT
  LEAD_CREATED_FROM_WP
  LEAD_ASSIGNED
  CREATE_RESERVATION
  UPDATE_RESERVATION
  CHANGE_STATUS
  QUOTE_SENT
  HOLD_SET
  EXPIRED_AUTO
  WHATSAPP_SENT
  WHATSAPP_RECEIVED
  GENERATE_REPORT
  NOTE
}

// === Suscripciones ===
enum SubscriptionPlan {
  STANDARD
  PREMIUM
  VIP
}

// === Opción de tiquete aéreo para selección ===
enum AirfareOption {
  WITH_AIRFARE
  WITHOUT_AIRFARE
}

// ======= Estado de el Match ========
enum MatchStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum TravelPointsTransactionType {
  ADMIN_GRANT     // admin o seller asigna puntos
  TRANSFER        // un usuario transfiere a otro (requiere Match)
  ADJUSTMENT      // correcciones manuales
  REDEEM          // canje (futuro)
}

// ================== Usuarios ==================
model User {
  id                    String     @id @default(uuid())
  email                 String     @unique
  name                  String?
  phone                 String?
  country               String?
  budget                String?
  preference            String[]
  destino               String[]
  password              String
  role                  Role       @default(USER)
  status                UserStatus @default(ACTIVE)
  verified              Boolean    @default(false)
  createdAt             DateTime   @default(now())
  avatar                String     @default("/images/default-avatar.png")
  timezone              String?
  commissionRate        Decimal?   @db.Decimal(5, 2)
  dniFile               String?
  passport              String?
  visa                  String?
  purchaseOrder         String?
  flightTickets         String?
  serviceVoucher        String?
  medicalAssistanceCard String?
  travelTips            String?
  comment               String?
  singleStatus          String?
  affirmation           String?
  acceptedTerms         Boolean?
  flow                  String?
  birthday              DateTime?
  gender                String?
  lookingFor            String?
  galleryImages         String[]   @default([])
  online                Boolean    @default(false)

  // ------------- Relaciones de Match & Chat ----------------

  // Relaciones del Match
  matchesAsUserA        Match[]   @relation("UserMatchesAsUserA")
  matchesAsUserB        Match[]   @relation("UserMatchesAsUserB")

  // Relación de Bloqueo
  blockedUsers          BlockedUser[] @relation("UserBloched")

  // Relaciones de mensajes
  sentMessages          Message[] @relation("SentMessages")
  receivedMessages      Message[] @relation("ReceivedMessages")

  // === Auto-asignación (aplica cuando role = SELLER)
  autoAssignable   Boolean  @default(true)
  assignmentWeight Int      @default(1)     // pesos para % (7/3 => 70%/30%)
  maxActiveClients Int?                     // tope opcional de clientes activos

  // Relaciones
  sellerClients       Client[]             @relation("SellerClients")
  sellerReservations  Reservation[]        @relation("SellerReservations")
  sellerTasks         Task[]               @relation("SellerTasks")
  passwordResetTokens PasswordResetToken[]

  whatsappNumber  String?
  currentlyLink   String?

  clientProfile Client? @relation("ClientUser")

  uploadedDocuments ReservationDocument[] @relation("UserUploadedDocuments")

  activities ActivityLog[] @relation("UserActivities")

  @@index([role, status])
}

// ================== Catálogo de Categorías ==================
model Category {
  id    String @id @default(uuid())
  name  String @unique
  slug  String @unique
  destinations Destination[]
}

// ================== Viajes / Destinos ==================
model Destination {
  id          String   @id @default(uuid())
  name        String
  country     String
  city        String?
  description String?
  isActive    Boolean  @default(true)
  popularityScore Int  @default(0)
  imageUrl        String?

  membership SubscriptionPlan @default(STANDARD)

  priceUSDWithAirfare     Decimal? @db.Decimal(12, 2)
  priceUSDWithoutAirfare  Decimal? @db.Decimal(12, 2)
  priceCOPWithAirfare     Decimal? @db.Decimal(14, 2)
  priceCOPWithoutAirfare  Decimal? @db.Decimal(14, 2)

  listUSDWithAirfare      Decimal? @db.Decimal(12, 2)
  listUSDWithoutAirfare   Decimal? @db.Decimal(12, 2)
  listCOPWithAirfare      Decimal? @db.Decimal(14, 2)
  listCOPWithoutAirfare   Decimal? @db.Decimal(14, 2)

  discountUSDWithAirfarePercent     Decimal? @db.Decimal(5, 2)
  discountUSDWithoutAirfarePercent  Decimal? @db.Decimal(5, 2)
  discountCOPWithAirfarePercent     Decimal? @db.Decimal(5, 2)
  discountCOPWithoutAirfarePercent  Decimal? @db.Decimal(5, 2)

  baseFromUSD Decimal? @db.Decimal(12, 2)
  baseFromCOP Decimal? @db.Decimal(14, 2)

  categories Category[]
  tripDates  TripDate[]
  reservations Reservation[]

  // legados
  price         Decimal? @db.Decimal(10, 2)
  discountPrice Decimal? @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, country, city])
  @@index([isActive, popularityScore])
  @@index([country, city])
  @@index([membership])
}

// === Fechas de viaje por destino ===
model TripDate {
  id            String      @id @default(uuid())
  destinationId String
  destination   Destination @relation(fields: [destinationId], references: [id], onDelete: Cascade)

  startDate DateTime
  endDate   DateTime

  isActive Boolean  @default(true)
  notes    String?
  capacity Int?

  reservations Reservation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([destinationId, startDate, endDate])
  @@index([isActive])
}

// ================== Clientes ==================
model Client {
  id       String @id @default(uuid())

  // AHORA OPCIONAL para no bloquear creación de Client
  sellerId String?
  seller   User?  @relation("SellerClients", fields: [sellerId], references: [id], onDelete: Restrict)

  userId String @unique
  user   User   @relation("ClientUser", fields: [userId], references: [id], onDelete: Cascade)

  name       String
  email      String?
  phone      String?
  documentId String?
  country    String?
  city       String?
  birthDate  DateTime?
  tags       String[]  @default([])
  notes      String?
  isArchived Boolean   @default(false)

  subscriptionPlan SubscriptionPlan @default(STANDARD)
  subscriptionCreatedAt   DateTime?
  subscriptionExpiresAt   DateTime?

  travelPoints Int @default(0)

  pointsSent     TravelPointsTransaction[] @relation("ClientPointsSent")
  pointsReceived TravelPointsTransaction[] @relation("ClientPointsReceived")

  reservations Reservation[]
  activities  ActivityLog[] @relation("ClientActivities")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sellerId, name])
  @@index([email])
  @@index([documentId])
  @@index([sellerId, subscriptionPlan])
}

// ================== Reservas ==================
model Reservation {
  id   String @id @default(uuid())

  code String @unique

  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  sellerId String
  seller   User   @relation("SellerReservations", fields: [sellerId], references: [id], onDelete: Restrict)

  destinationId String
  destination   Destination @relation(fields: [destinationId], references: [id], onDelete: Restrict)

  tripDateId String?
  tripDate   TripDate? @relation(fields: [tripDateId], references: [id], onDelete: SetNull)

  startDate   DateTime
  endDate     DateTime
  paxAdults   Int      @default(1)
  paxChildren Int      @default(0)

  documents ReservationDocument[]

  currency    String            @default("USD")
  totalAmount Decimal           @default(0) @db.Decimal(12, 2)

  airfareOption AirfareOption @default(WITHOUT_AIRFARE)

  status      ReservationStatus @default(LEAD)
  notes       String?

  tasks      Task[]        @relation("ReservationTasks")
  activities ActivityLog[] @relation("ReservationActivities")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sellerId, status])
  @@index([destinationId, status])
  @@index([startDate, endDate])
  @@index([clientId])
  @@index([tripDateId])
}

model Task {
  id        String   @id @default(uuid())

  sellerId String
  seller   User   @relation("SellerTasks", fields: [sellerId], references: [id], onDelete: Cascade)

  reservationId String?
  reservation   Reservation? @relation("ReservationTasks", fields: [reservationId], references: [id])

  title       String
  description String?
  dueDate     DateTime?
  status      TaskStatus   @default(OPEN)
  priority    TaskPriority @default(MEDIUM)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sellerId, status, priority])
  @@index([reservationId])
}

model ActivityLog {
  id      String   @id @default(uuid())

  action   ActivityAction
  message  String?
  metadata Json?

  userId String?
  user   User?   @relation("UserActivities", fields: [userId], references: [id], onDelete: SetNull)

  clientId String?
  client   Client? @relation("ClientActivities", fields: [clientId], references: [id], onDelete: SetNull)

  reservationId String?
  reservation   Reservation? @relation("ReservationActivities", fields: [reservationId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([action, createdAt])
  @@index([userId])
  @@index([clientId])
  @@index([reservationId])
}

model ReservationDocument {
  id             String   @id @default(uuid())
  reservationId  String
  reservation    Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)

  type           DocumentType
  url            String
  uploadedAt     DateTime @default(now())

  uploadedById   String?
  uploadedBy     User? @relation("UserUploadedDocuments", fields: [uploadedById], references: [id], onDelete: SetNull)
}



model PasswordResetToken {
  id        String  @id @default(uuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  tokenHash String  @unique
  expiresAt DateTime
  usedAt    DateTime?
  ip        String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([userId, expiresAt])
}

model Match {
  id        String   @id @default(uuid())
  userAId   String
  userBId   String
  status    MatchStatus @default(PENDING)
  createdAt DateTime @default(now())

  // Relaciones con la tabla User
  userA     User     @relation("UserMatchesAsUserA", fields: [userAId], references: [id])
  userB     User     @relation("UserMatchesAsUserB", fields: [userBId], references: [id])

  // Aseguramos que solo haya un match (pendiente/aceptado) entre dos usuarios
  @@unique([userAId, userBId])
  @@index([userAId, status])
  @@index([userBId, status])
}

model BlockedUser {
  id            String   @id @default(uuid())
  blockerUserId String
  blockedUserId String
  createdAt     DateTime @default(now())

  // Relaciones con la tabla User
  blocker       User  @relation("UserBloched", fields: [blockerUserId], references: [id])

  @@unique([blockerUserId, blockedUserId])
}

model Message {
  id            String   @id @default(uuid())
  senderId      String
  receiverId    String
  content       String?
  imageUrl      String?
  createdAt     DateTime @default(now())
  readAt        DateTime?
  deletedBy     Json[]   // Para eliminación logica por usuario 

  // Relaciones con la tabla User
  sender        User  @relation("SentMessages", fields: [senderId], references: [id])
  receiver      User  @relation("ReceivedMessages", fields: [receiverId], references: [id])

  @@index([senderId, receiverId, createdAt])
  @@index([receiverId, createdAt]) // Para cargar mensajes entrantes 
}

model TravelPointsTransaction {
  id        String   @id @default(uuid())

  type      TravelPointsTransactionType
  amount    Int
  note      String?

  // Desde qué cliente se envían los puntos
  fromClientId String?
  fromClient   Client? @relation("ClientPointsSent", fields: [fromClientId], references: [id], onDelete: SetNull)

  // A qué cliente se le asignan puntos
  toClientId String?
  toClient   Client? @relation("ClientPointsReceived", fields: [toClientId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([fromClientId])
  @@index([toClientId])
  @@index([type, createdAt])
}
